services:
#-----------------------------------------------#
#     AUTHELIA - SSO Management                  #
#-----------------------------------------------#
  authelia:
    image: authelia/authelia:latest
    container_name: authelia
    volumes:
      - ${DATA_ROOT}/authelia/config:/config
    environment:
      - TZ=${TZ}
    ports:
      - "9091:9091"
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     BAZARR - Subtitles                        #
#-----------------------------------------------#
  bazarr:
    container_name: bazarr
    image: ghcr.io/hotio/bazarr:latest
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${BAZARR_CONFIG}:/config
      - ${DATA_ROOT}/${DATA}:/data
      - T:/:/data/media/tv
    ports:
      - "${BAZARR_PORT}:6767"
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     BEETS - Music Library Management          #
#-----------------------------------------------#
  beets:
    container_name: beets
    image: lscr.io/linuxserver/beets:latest
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${BEETS_CONFIG}:/config
      - ${DATA_ROOT}/${DATA_MEDIA}/music:/music
      - ${DATA_ROOT}/${DATA_TORRENTS}:/downloads
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     CADDY - Reverse Proxy                     #
#-----------------------------------------------#
  caddy:
    container_name: caddy
    image: caddy:2
    env_file: .env
    volumes:
      - ${DATA_ROOT}/caddy/Caddyfile:/etc/caddy/Caddyfile
      - ${DATA_ROOT}/${CADDY_DATA}:/data
      - ${DATA_ROOT}/${CADDY_CONFIG}:/config
      - ${DATA_ROOT}/caddy/logs/:/var/log/caddy/
    ports:
      - "443:443"
      - "80:80"
    extra_hosts:
      - "auth.phoenix-server.cc:172.18.0.30"
    networks:
      - default
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -zv sonarr 8989 >/dev/null 2>&1 && nc -zv radarr 7878 >/dev/null 2>&1 && nc -zv lidarr 8686 >/dev/null 2>&1 || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      authelia:
        condition: service_started
      calibre:
        condition: service_started
      homeassistant:
        condition: service_started
      homarr:
        condition: service_started
      homepage:
        condition: service_started
      immich:
        condition: service_healthy
      jellyfin:
        condition: service_started
      jellyseerr:
        condition: service_started
      joplin:
        condition: service_started
      komga:
        condition: service_started
      lidarr:
        condition: service_started
      mylar3:
        condition: service_started
      organizr:
        condition: service_started
      qbittorrent:
        condition: service_started
      radarr:
        condition: service_started
      readarr:
        condition: service_started
      sabnzbd:
        condition: service_started
      scrutiny:
        condition: service_started
      sonarr:
        condition: service_started
      tandoor:
        condition: service_started
      tautulli:
        condition: service_started
      vaultwarden:
        condition: service_healthy
      whisparr:
        condition: service_started
      tunarr:
        condition: service_started


#-----------------------------------------------#
#     CALIBRE WEB - E-Book Reader Web UI        #
#-----------------------------------------------#
  calibre:
    container_name: calibre
    image: linuxserver/calibre-web
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
      PORT: ${CALIBRE_WEB_PORT}
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${CALIBRE_CONFIG}:/config
    ports:
      - "${CALIBRE_WEB_PORT}:${CALIBRE_WEB_PORT}"
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     CALIBRE CONTENT SERVER - For Readarr API  #
#-----------------------------------------------#
  calibre-server:
    container_name: calibre-server
    image: linuxserver/calibre:latest
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
    volumes:
      - ${DATA_ROOT}/${CALIBRE_CONFIG}:/config
      - ${DATA_ROOT}/${MEDIA_BOOKS}:/data/books
    ports:
      - "${CALIBRE_SERVER_PORT}:8080"
    networks:
      - default
    restart: unless-stopped
    depends_on:
      - calibre
    entrypoint: []
    command: ["/usr/bin/calibre-server", "--port=8080", "--enable-local-write", "--trusted-ips=172.18.0.0/16", "/config/CalibreLibrary"]


#-----------------------------------------------#
#     CLOUDFLARED - Cloudflare Tunnel           #
#-----------------------------------------------#
  cloudflared:
    container_name: cloudflared
    image: cloudflare/cloudflared:latest
    command: tunnel --config /etc/cloudflared/config.yml run
    restart: unless-stopped
    volumes:
      - ${DATA_ROOT}/${CLOUDFLARED_CONFIG}/config.yml:/etc/cloudflared/config.yml:ro
      - ${DATA_ROOT}/${CLOUDFLARED_CONFIG}/11841668-d562-40bb-b307-72c6eceb7eb1.json:/etc/cloudflared/11841668-d562-40bb-b307-72c6eceb7eb1.json:ro
      - ${DATA_ROOT}/${CLOUDFLARED_CONFIG}/cert.pem:/etc/cloudflared/cert.pem:ro
    networks:
      - default
    depends_on:
      - caddy
    
  flaresolverr:
    container_name: flaresolverr
    image: flaresolverr/flaresolverr:latest
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
    ports:
      - "${FLARESOLVERR_PORT}:${FLARESOLVERR_PORT}"
    networks:
      - default
    restart: unless-stopped

#-----------------------------------------------#
#     DECLUTTARR - Media Cleanup                #
#-----------------------------------------------#
  decluttarr:
    container_name: decluttarr
    image: ghcr.io/manimatter/decluttarr:v1.50.2
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
      UMASK_SET: 022
      SONARR_URL: "http://sonarr:${SONARR_PORT}"
      SONARR_KEY: ${SONARR_API_KEY}
      RADARR_URL: "http://radarr:${RADARR_PORT}"
      RADARR_KEY: ${RADARR_API_KEY}
      LIDARR_URL: "http://lidarr:${LIDARR_PORT}"
      LIDARR_KEY: ${LIDARR_API_KEY}
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${DECLUTTARR_CONFIG}/config.yaml:/app/config/config.yaml
      - ${DATA_ROOT}/${DECLUTTARR_DATA}/logs:/app/logs
      - ${DATA_ROOT}/${DATA_MEDIA}:/media
    ports:
      - "${DECLUTTARR_PORT}:${DECLUTTARR_PORT}"
    networks:
      - default
    restart: unless-stopped

#-----------------------------------------------#
#     HOMARR - Serve Dashboard                  #
#-----------------------------------------------#
  homarr:
    container_name: homarr
    image: ghcr.io/homarr-labs/homarr:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # Optional, only if you want docker integration
      - ${DATA_ROOT}/${HOMARR_DATA}:/appdata
    environment:
      SECRET_ENCRYPTION_KEY: ${HOMARR_KEY}
      DB_DRIVER: node-postgres
      DB_DIALECT: postgresql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: homarr
      DB_USER: ${HOMARR_DB_USER}
      DB_PASSWORD: ${HOMARR_DB_PASS}
    ports:
      - '${HOMARR_PORT}:${HOMARR_PORT}'
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     HOMEPAGE - Modern Dashboard               #
#-----------------------------------------------#
  homepage:
    container_name: homepage
    image: ghcr.io/benphelps/homepage:latest
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ./configs/homepage:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "${HOMEPAGE_PORT}:3000"
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#    HOMEASSISTANT - Home Automation            #
#-----------------------------------------------#
  homeassistant:
    container_name: homeassistant
    image: ghcr.io/home-assistant/home-assistant:stable
    environment:
      TZ: ${TZ}
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${HOMEASSISTANT_CONFIG}:/config
    ports:
      - "${HOMEASSISTANT_PORT}:${HOMEASSISTANT_PORT}"
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     IMMICH - Photo Management                 #
#-----------------------------------------------#
  immich:
    container_name: immich
    image: ghcr.io/immich-app/immich-server:release
    environment:
      TZ: ${TZ}
      DB_URL: postgres://${IMMICH_DB_USER}:${IMMICH_DB_PASS}@postgres:5432/immich
      IMMICH_LOG_LEVEL: log
      REDIS_HOSTNAME: redis
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${IMMICH_CONFIG}:/config
      - ${DATA_ROOT}/${IMMICH_DATA}:/data
    ports:
      - "${IMMICH_PORT}:${IMMICH_PORT}"
    networks:
      - default
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started


#-----------------------------------------------#
#     JELLYFIN - Media Server                   #
#-----------------------------------------------#
  jellyfin:
    container_name: jellyfin
    image: jellyfin/jellyfin:latest
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${JELLYFIN_CONFIG}:/config
      - ${DATA_ROOT}/${JELLYFIN_CACHE}:/cache
      - ${DATA_ROOT}/${DATA_MEDIA}:/data/media
    ports:
      - "${JELLYFIN_PORT}:${JELLYFIN_PORT}"
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     JELLYSEERR - Request Management           #
#-----------------------------------------------#
  jellyseerr:
    container_name: jellyseerr
    image: fallenbagel/jellyseerr:latest
    environment:
      LOG_LEVEL: debug
      TZ: ${TZ}
      DB_TYPE: postgres
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: jellyseerr
      DB_USER: ${JELLYSEERR_DB_USER}
      DB_PASS: ${JELLYSEERR_DB_PASS}
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${JELLYSEERR_CONFIG}:/app/config
    ports:
      - "${JELLYSEERR_PORT}:${JELLYSEERR_PORT}"
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     JOPLIN - Note Taking                      #
#-----------------------------------------------#
  joplin:
    container_name: joplin
    image: joplin/server:latest
    environment:
      APP_BASE_URL: https://joplin.phoenix-server.cc
      APP_PORT: ${JOPLIN_PORT}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DATABASE: joplin
      POSTGRES_USER: ${JOPLIN_DB_USER}
      POSTGRES_PASSWORD: ${JOPLIN_DB_PASS}
      MAILER_ENABLED: 0
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${JOPLIN_CONFIG}:/var/lib/joplin
    ports:
      - "${JOPLIN_PORT}:${JOPLIN_PORT}"
    networks:
      - default
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy


#-----------------------------------------------#
#     LIDARR - Music                            #
#-----------------------------------------------#
  lidarr:
    container_name: lidarr
    image: linuxserver/lidarr:develop
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${LIDARR_CONFIG}:/config
      - ${DATA_ROOT}/${DATA}:/data
    ports:
      - "${LIDARR_PORT}:${LIDARR_PORT}"
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     MYLAR3 - Comic Books                      #
#-----------------------------------------------#
  mylar3:
    container_name: mylar3
    image: lscr.io/linuxserver/mylar3:latest
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${MYLAR3_CONFIG}:/config
      - ${DATA_ROOT}/${DATA_MEDIA}:/data
      - ${DATA_ROOT}/${MEDIA_COMICS}:/comics
    ports:
      - "${MYLAR3_PORT}:${MYLAR3_PORT}"
    networks:
      - default
    restart: unless-stopped
    depends_on:
      prowlarr:
        condition: service_started
      qbittorrent:
        condition: service_started


#-----------------------------------------------#
#     KOMGA - Comic Book Server                #
#-----------------------------------------------#
  komga:
    container_name: komga
    image: ghcr.io/gotson/komga:latest
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${KOMGA_CONFIG}:/config
      - ${DATA_ROOT}/${MEDIA_COMICS}:/data
    ports:
      - "${KOMGA_PORT}:25600"
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     ORGANIZR - HTPC Dashboard                #
#-----------------------------------------------#
  organizr:
    container_name: organizr
    image: organizr/organizr:latest
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${ORGANIZR_CONFIG}:/config
    ports:
      - "${ORGANIZR_PORT}:80"
    networks:
      - default
    restart: unless-stopped
        
        
#-----------------------------------------------#
#     PGLOADER - Database Migration             #
#-----------------------------------------------#
  pgloader:
    image: dimitri/pgloader:latest
    container_name: pgloader
    profiles: ["manual"]
    networks:
      - default
    volumes:
      - /home/jeremy/media-servarr-app-data/server-backups:/data:ro
    entrypoint: ["tail", "-f", "/dev/null"]


#-----------------------------------------------#
#     PLEX - Media Server                       #
#-----------------------------------------------#
  plex:
    container_name: plex
    image: linuxserver/plex
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
      VERSION: latest
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${PLEX_CONFIG}:/config
      - ${DATA_ROOT}/${DATA_MEDIA}:/data/media
      - T:/:/data/media/tv
    ports:
      - "${PLEX_PORT}:32400"
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     PORTAINER - Docker Management UI          #
#-----------------------------------------------#
  portainer:
    container_name: portainer
    image: portainer/portainer-ce:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${DATA_ROOT}/${PORTAINER_DATA}:/data
    ports:
      - "${PORTAINER_PORT}:9000"
    networks:
      - default
    restart: unless-stopped

  portainer-backup:
    container_name: portainer-backup
    image: alpine:latest
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    environment:
      TZ: ${TZ}
    volumes:
      - ${DATA_ROOT}/server-backups:/backups
      - ${DATA_ROOT}/${PORTAINER_DATA}:/source:ro
      - ./portainer-backup.sh:/usr/local/bin/backup.sh:ro
    entrypoint: ["/bin/sh", "/usr/local/bin/backup.sh"]
    networks:
      - default
    depends_on:
      - portainer
    # Run manually with: docker-compose run --rm portainer-backup
    # Or schedule with cron/task scheduler



#-----------------------------------------------#
#     POSTGRES - Database                       #
#-----------------------------------------------#
  postgres:
    container_name: postgres
    image: pgvector/pgvector:pg18
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    environment:
      POSTGRES_INITDB_ARGS: "--locale=en_US.UTF-8 --encoding=UTF8"
      TZ: ${TZ}
      POSTGRES_PASSWORD: ${POSTGRES_PASS}
      POSTGRES_USER: ${POSTGRES_USER}
      PGDATA: /var/lib/postgresql/data      
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - postgres-data:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d
    ports:
      - "${POSTGRES_PORT}:${POSTGRES_PORT}"
    networks:
      - default
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
      
  postgres-backup:
    container_name: postgres-backup
    image: postgres:18
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASS}
      TZ: America/Halifax
    volumes:
      - E:/media-servarr-app-data/server-backups:/backups
      - ./postgres-backup.sh:/usr/local/bin/backup.sh:ro
      - ./postgres-backup-cron.sh:/usr/local/bin/backup-cron.sh:ro
      - ./portainer-backup.sh:/usr/local/bin/portainer-backup.sh:ro
      - ${DATA_ROOT}/${PORTAINER_DATA}:/source-portainer:ro
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        # Install cron if not available
        if ! command -v cron &> /dev/null; then
          apt-get update && apt-get install -y cron && rm -rf /var/lib/apt/lists/*
        fi
        # Copy cron wrapper to writable location (backup.sh is already executable from mount)
        # /usr/local/bin should be writable, so we can copy the wrapper there
        cp /usr/local/bin/backup-cron.sh /usr/local/bin/backup-cron-wrapper.sh
        chmod +x /usr/local/bin/backup-cron-wrapper.sh
        # Set up crontab (wrapper script will read env vars from /proc/1/environ)
        echo "30 2 * * * /usr/local/bin/backup-cron-wrapper.sh" | crontab -
        # Start cron in foreground
        echo "PostgreSQL backup scheduler started. Backups will run daily at 2:30 AM ${TZ}"
        echo "Current time: $(date)"
        echo "Crontab installed:"
        crontab -l
        cron -f
    networks:
      - default
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    
    
#-----------------------------------------------#
#     PROWLARR - Indexer                        #
#-----------------------------------------------#
  prowlarr:
    container_name: prowlarr
    image: linuxserver/prowlarr:latest
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${PROWLARR_CONFIG}:/config
    ports:
      - "${PROWLARR_PORT}:${PROWLARR_PORT}"
    networks:
      - default
    restart: unless-stopped
    
    
#-----------------------------------------------#
#     QBITTORRENT - Torrent Download Client     #
#-----------------------------------------------#
  qbittorrent:
    container_name: qbittorrent
    image: linuxserver/qbittorrent:latest
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
      WEBUI_PORT: ${QBITTORRENT_WEB_PORT}
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${QBITTORRENT_CONFIG}:/config
      - ${DATA_ROOT}/${DATA_TORRENTS}:/data/torrents
    ports:
      - "${QBITTORRENT_WEB_PORT}:${QBITTORRENT_WEB_PORT}"
      - "6881:6881"
      - "6881:6881/udp"
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     RADARR - Movies                           #
#-----------------------------------------------#
  radarr:
    container_name: radarr
    image: linuxserver/radarr:develop
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
      RADARR__POSTGRES_HOST: postgres
      RADARR__POSTGRES_PORT: 5432
      RADARR__POSTGRES_USER: ${RADARR_DB_USER}
      RADARR__POSTGRES_PASSWORD: ${RADARR_DB_PASS}
      RADARR__POSTGRES_MAINDB: radarr
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${RADARR_CONFIG}:/config
      - ${DATA_ROOT}/${DATA}:/data
    ports:
      - "${RADARR_PORT}:${RADARR_PORT}"
    networks:
      - default
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      prowlarr:
        condition: service_started
      qbittorrent:
        condition: service_started


#-----------------------------------------------#
#     READARR - Books                           #
#-----------------------------------------------#
  readarr:
    container_name: readarr
    image: ghcr.io/hotio/readarr:latest
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${READARR_CONFIG}:/config
      - ${DATA_ROOT}/${CALIBRE_CONFIG}:/calibre
      - ${DATA_ROOT}/${DATA}:/data
    ports:
      - "${READARR_PORT}:${READARR_PORT}"
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     REDIS - Cache Server                      #
#-----------------------------------------------#
  redis:
    container_name: redis
    image: redis:7
    restart: unless-stopped
    networks:
      - default


#-----------------------------------------------#
#     SCRUTINY - Hard Drive Health Monitor     #
#-----------------------------------------------#
  scrutiny:
    container_name: scrutiny
    image: ghcr.io/analogj/scrutiny:master-omnibus
    privileged: true
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
      # Exclude virtual devices (WSL virtual disks don't support SMART)
      SCRUTINY_EXCLUDE_PATTERNS: ".*Virtual.*|.*loop.*"
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${SCRUTINY_CONFIG}:/opt/scrutiny/config
      - ${DATA_ROOT}/${SCRUTINY_INFLUXDB}:/opt/scrutiny/influxdb
      - /run/udev:/run/udev:ro
    ports:
      - "${SCRUTINY_PORT}:8080"
      - "${SCRUTINY_INFLUXDB_PORT}:8086"
    cap_add:
      - SYS_RAWIO
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     SABNZBD - Usenet Download Client          #
#-----------------------------------------------#
  sabnzbd:
    container_name: sabnzbd
    image: ghcr.io/hotio/sabnzbd:latest
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: "${TZ}"
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${SABNZBD_CONFIG}:/config
      - ${DATA_ROOT}/${DATA_USENET}:/data/usenet
    ports:
      - "${SABNZBD_WEB_PORT}:8080"
      - "9090:9090"
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     SONARR - TV Shows                         #
#-----------------------------------------------#
  sonarr:
    container_name: sonarr
    image: linuxserver/sonarr:develop
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${SONARR_CONFIG}:/config
      - ${DATA_ROOT}/${DATA_MEDIA}:/data/media
      - T:/:/data/media/tv
    ports:
      - "${SONARR_PORT}:${SONARR_PORT}"
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     SUBGENAI - AI Subtitle Generator          #
#-----------------------------------------------#
  subgenai:
    container_name: subgenai
    image: mccloud/subgen:cpu
    tty: true
    environment:
      WEBHOOKPORT: ${SUBGEN_PORT}
      PLEXTOKEN: ${PLEX_TOKEN}
      PLEXSERVER: http://plex:${PLEX_PORT}
    volumes:
      - ${DATA_ROOT}/${DATA_MEDIA}:/data/media
      - T:/:/data/media/tv
      - ${DATA_ROOT}/${SUBGENAI_DATA}/models:/subgen/models
      - ${DATA_ROOT}/${SUBGENAI_DATA}/subgen.env:/subgen/subgen.env:ro
    ports:
       - "${SUBGEN_PORT}:9000"
    networks:
      - default
    depends_on:
      bazarr:
        condition: service_started


#-----------------------------------------------#
#     TANDOOR - Recipe Management               #
#-----------------------------------------------#
  tandoor:
    container_name: tandoor
    image: vabene1111/recipes:tandoor-v1
    environment:
      TZ: ${TZ}
      POSTGRES_HOST: postgres://postgres:5432
      POSTGRES_DB: djangodb
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${TANDOOR_DB_USER}
      POSTGRES_PASSWORD: ${TANDOOR_DB_PASS}
      SECRET_KEY: ${TANDOOR_SECRET_KEY}
      ALLOWED_HOSTS: 127.0.0.1,localhost,192.168.2.10,tandoor.phoenix-server.cc
      CSRF_TRUSTED_ORIGINS: http://192.168.2.10,http://localhost,http://127.0.0.1,http://fubarmedia.servebeer.com,https://tandoor.phoenix-server.cc
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${TANDOOR_CONFIG}:/shared
      - ${DATA_ROOT}/${TANDOOR_CONFIG}/mediafiles:/opt/recipes/mediafiles
      - ${DATA_ROOT}/${TANDOOR_CONFIG}/staticfiles:/opt/recipes/staticfiles
    ports:
      - "${TANDOOR_PORT}:80"
    networks:
      - default
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy


#-----------------------------------------------#
#     TAUTULLI - PLEX Monitor                   #
#-----------------------------------------------#
  tautulli:
    container_name: tautulli
    image: ghcr.io/tautulli/tautulli:latest
    restart: unless-stopped
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
      TAUTULLI__HTTP_PROXY: 1
      TAUTULLI__HTTP_FORCE_SSL: 1
      TAUTULLI__HTTP_ROOT: /
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${TAUTULLI_CONFIG}:/config
      - ${DATA_ROOT}/${TAUTULLI_LOGS}:/logs
    ports:
      - "${TAUTULLI_PORT}:8181"
    networks:
      - default


#-----------------------------------------------#
#     TUNARR - Custom Streaming Channels        #
#-----------------------------------------------#
  tunarr:
    container_name: tunarr
    image: chrisbenincasa/tunarr:latest
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
      TUNARR_SERVER_ADMIN_MODE: "true"
      TUNARR_SERVER_TRUST_PROXY: "true"
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${TUNARR_CONFIG}:/config/tunarr
      - ${DATA_ROOT}/${DATA_MEDIA}:/media
    ports:
      - "${TUNARR_PORT}:8000"
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     VAULTWARDEN - Password Manager            #
#-----------------------------------------------#
  vaultwarden:
    container_name: vaultwarden
    image: vaultwarden/server:latest
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:80 || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 30s
    env_file: ${DATA_ROOT}/${VAULT_CONFIG}/vaultwarden.env
    environment:
      WEBSOCKET_ENABLED: "true"
      DATABASE_URL: "postgres://${VAULT_DB_USER}:${VAULT_DB_PASS}@postgres:5432/vaultwarden"
      # External URL configuration
      DOMAIN: "https://vaultwarden.phoenix-server.cc"
      # Tell Vaultwarden to always assume HTTPS when behind reverse proxy
      FORCE_HTTPS: "true"
      # Logging
      EXTENDED_LOGGING: "true"
      LOG_LEVEL: "info"
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${VAULT_CONFIG}:/data
    ports:
      - "${VAULT_PORT}:80"
    networks:
      - default
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy

#-----------------------------------------------#
#    WHISPARR - Adult Media                     #
#-----------------------------------------------#
  whisparr:
    container_name: whisparr
    image: ghcr.io/hotio/whisparr:latest
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
    volumes:
      - ${DATA_ROOT}/${BACKUPS}:/backup
      - ${DATA_ROOT}/${WHISPARR_CONFIG}:/config
      - ${DATA_ROOT}/${DATA}:/data
    ports:
      - "${WHISPARR_PORT}:${WHISPARR_PORT}"
    networks:
      - default
    restart: unless-stopped


#-----------------------------------------------#
#     WATCHTOWER - Auto-update Containers       #
#-----------------------------------------------#
  watchtower:
    container_name: watchtower
    image: containrrr/watchtower:latest
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_REVIVE_STOPPED=false
      - WATCHTOWER_POLL_INTERVAL=3600
      - TZ=${TZ}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --interval 3600 --cleanup
    networks:
      - default
    restart: unless-stopped

#-----------------------------------------------#
#     NETWORK                                   #
#-----------------------------------------------# 
networks:
  default:
    driver: bridge

#-----------------------------------------------#
#     VOLUMES                                    #
#-----------------------------------------------#
volumes:
  postgres-data:
    name: media-servarr_postgres-data